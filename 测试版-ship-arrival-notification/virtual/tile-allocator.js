import { C } from './prun-css.js';
import tiles from './tiles.js';
import { _$$, _$, $ } from './select-dom.js';
import { getPrunId } from './attributes.js';
import { UI_TILES_CHANGE_COMMAND } from './client-messages.js';
import { dispatchClientPrunMessage } from './prun-api-listener.js';
import { clickElement, changeInputValue } from './util.js';
import { sleep } from './sleep.js';
import { setBufferSize, showBuffer } from './buffers.js';
class TileAllocator {
  allocatedTile;
  constructor(options) {
    const { tile } = options;
    const isSoloBuffer = tile.container.classList.contains(C.Window.body);
    if (isSoloBuffer) {
      options.onBufferSplit();
      splitBuffer(tile);
    } else {
      this.allocatedTile = getCompanionTile(tile);
    }
  }
  async requestTile(command) {
    if (this.allocatedTile?.isConnected) {
      await changeTileCommand(this.allocatedTile, command);
    } else {
      this.allocatedTile = await requestTile(command);
    }
    return tiles.findByContainer(this.allocatedTile?.parentElement)[0];
  }
}
function getCompanionTile(tile) {
  const isInNodeChild = tile.container.classList.contains(C.Node.child);
  const isInNode = tile.container.parentElement?.classList.contains(C.Node.node);
  const isInWindow = tile.container.parentElement?.parentElement?.classList.contains(C.Window.body);
  if (!isInNodeChild || !isInNode || !isInWindow) {
    return void 0;
  }
  const node = tile.container.parentElement;
  const sibling = _$$(node, C.Node.child).find(x => x !== tile.container);
  return _$(sibling, C.Tile.tile);
}
async function changeTileCommand(tile, command) {
  const id = getPrunId(tile);
  let message = UI_TILES_CHANGE_COMMAND(id, null);
  if (!dispatchClientPrunMessage(message)) {
    const changeButton = _$$(tile, C.TileControls.control).find(x => x.textContent === ':');
    await clickElement(changeButton);
  } else {
    await sleep(0);
  }
  message = UI_TILES_CHANGE_COMMAND(id, command);
  if (!dispatchClientPrunMessage(message)) {
    const input = await $(tile, C.PanelSelector.input);
    changeInputValue(input, command);
    input.form.requestSubmit();
  }
  await $(tile, C.TileFrame.frame);
}
async function requestTile(command) {
  const window = await showBuffer(command, { autoSubmit: true });
  await sleep(0);
  const body = _$(window, C.Window.body);
  return body ? _$(body, C.Tile.tile) : void 0;
}
function splitBuffer(tile) {
  const width = parseInt(tile.container.style.width.replace('px', ''), 10);
  const height = parseInt(tile.container.style.height.replace('px', ''), 10);
  setBufferSize(tile.id, width + 450, height);
  const changeButton = _$$(tile.frame, C.TileControls.control).find(x => x.textContent === '|');
  void clickElement(changeButton);
}
export { TileAllocator };
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGlsZS1hbGxvY2F0b3IuanMiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9mZWF0dXJlcy9YSVQvQUNUL3J1bm5lci90aWxlLWFsbG9jYXRvci50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBnZXRQcnVuSWQgfSBmcm9tICdAc3JjL2luZnJhc3RydWN0dXJlL3BydW4tdWkvYXR0cmlidXRlcyc7XG5pbXBvcnQgeyBVSV9USUxFU19DSEFOR0VfQ09NTUFORCB9IGZyb20gJ0BzcmMvaW5mcmFzdHJ1Y3R1cmUvcHJ1bi1hcGkvY2xpZW50LW1lc3NhZ2VzJztcbmltcG9ydCB7IGRpc3BhdGNoQ2xpZW50UHJ1bk1lc3NhZ2UgfSBmcm9tICdAc3JjL2luZnJhc3RydWN0dXJlL3BydW4tYXBpL3BydW4tYXBpLWxpc3RlbmVyJztcbmltcG9ydCB7IGNoYW5nZUlucHV0VmFsdWUsIGNsaWNrRWxlbWVudCB9IGZyb20gJ0BzcmMvdXRpbCc7XG5pbXBvcnQgeyBzbGVlcCB9IGZyb20gJ0BzcmMvdXRpbHMvc2xlZXAnO1xuaW1wb3J0IHsgc2V0QnVmZmVyU2l6ZSwgc2hvd0J1ZmZlciB9IGZyb20gJ0BzcmMvaW5mcmFzdHJ1Y3R1cmUvcHJ1bi11aS9idWZmZXJzJztcblxuaW50ZXJmYWNlIFRpbGVBbGxvY2F0b3JPcHRpb25zIHtcbiAgdGlsZTogUHJ1blRpbGU7XG4gIG9uQnVmZmVyU3BsaXQ6ICgpID0+IHZvaWQ7XG59XG5cbmV4cG9ydCBjbGFzcyBUaWxlQWxsb2NhdG9yIHtcbiAgcHJpdmF0ZSBhbGxvY2F0ZWRUaWxlPzogSFRNTEVsZW1lbnQ7XG5cbiAgY29uc3RydWN0b3Iob3B0aW9uczogVGlsZUFsbG9jYXRvck9wdGlvbnMpIHtcbiAgICBjb25zdCB7IHRpbGUgfSA9IG9wdGlvbnM7XG4gICAgY29uc3QgaXNTb2xvQnVmZmVyID0gdGlsZS5jb250YWluZXIuY2xhc3NMaXN0LmNvbnRhaW5zKEMuV2luZG93LmJvZHkpO1xuICAgIGlmIChpc1NvbG9CdWZmZXIpIHtcbiAgICAgIG9wdGlvbnMub25CdWZmZXJTcGxpdCgpO1xuICAgICAgc3BsaXRCdWZmZXIodGlsZSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuYWxsb2NhdGVkVGlsZSA9IGdldENvbXBhbmlvblRpbGUodGlsZSk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgcmVxdWVzdFRpbGUoY29tbWFuZDogc3RyaW5nKSB7XG4gICAgaWYgKHRoaXMuYWxsb2NhdGVkVGlsZT8uaXNDb25uZWN0ZWQpIHtcbiAgICAgIGF3YWl0IGNoYW5nZVRpbGVDb21tYW5kKHRoaXMuYWxsb2NhdGVkVGlsZSwgY29tbWFuZCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuYWxsb2NhdGVkVGlsZSA9IGF3YWl0IHJlcXVlc3RUaWxlKGNvbW1hbmQpO1xuICAgIH1cbiAgICByZXR1cm4gdGlsZXMuZmluZEJ5Q29udGFpbmVyKHRoaXMuYWxsb2NhdGVkVGlsZT8ucGFyZW50RWxlbWVudClbMF07XG4gIH1cbn1cblxuZnVuY3Rpb24gZ2V0Q29tcGFuaW9uVGlsZSh0aWxlOiBQcnVuVGlsZSkge1xuICBjb25zdCBpc0luTm9kZUNoaWxkID0gdGlsZS5jb250YWluZXIuY2xhc3NMaXN0LmNvbnRhaW5zKEMuTm9kZS5jaGlsZCk7XG4gIGNvbnN0IGlzSW5Ob2RlID0gdGlsZS5jb250YWluZXIucGFyZW50RWxlbWVudD8uY2xhc3NMaXN0LmNvbnRhaW5zKEMuTm9kZS5ub2RlKTtcbiAgY29uc3QgaXNJbldpbmRvdyA9IHRpbGUuY29udGFpbmVyLnBhcmVudEVsZW1lbnQ/LnBhcmVudEVsZW1lbnQ/LmNsYXNzTGlzdC5jb250YWlucyhDLldpbmRvdy5ib2R5KTtcbiAgaWYgKCFpc0luTm9kZUNoaWxkIHx8ICFpc0luTm9kZSB8fCAhaXNJbldpbmRvdykge1xuICAgIHJldHVybiB1bmRlZmluZWQ7XG4gIH1cblxuICBjb25zdCBub2RlID0gdGlsZS5jb250YWluZXIucGFyZW50RWxlbWVudCE7XG4gIGNvbnN0IHNpYmxpbmcgPSBfJCQobm9kZSwgQy5Ob2RlLmNoaWxkKS5maW5kKHggPT4geCAhPT0gdGlsZS5jb250YWluZXIpITtcbiAgcmV0dXJuIF8kKHNpYmxpbmcsIEMuVGlsZS50aWxlKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gY2hhbmdlVGlsZUNvbW1hbmQodGlsZTogSFRNTEVsZW1lbnQsIGNvbW1hbmQ6IHN0cmluZykge1xuICBjb25zdCBpZCA9IGdldFBydW5JZCh0aWxlKSE7XG4gIGxldCBtZXNzYWdlID0gVUlfVElMRVNfQ0hBTkdFX0NPTU1BTkQoaWQsIG51bGwpO1xuICBpZiAoIWRpc3BhdGNoQ2xpZW50UHJ1bk1lc3NhZ2UobWVzc2FnZSkpIHtcbiAgICBjb25zdCBjaGFuZ2VCdXR0b24gPSBfJCQodGlsZSwgQy5UaWxlQ29udHJvbHMuY29udHJvbCkuZmluZCh4ID0+IHgudGV4dENvbnRlbnQgPT09ICc6Jyk7XG4gICAgYXdhaXQgY2xpY2tFbGVtZW50KGNoYW5nZUJ1dHRvbik7XG4gIH0gZWxzZSB7XG4gICAgYXdhaXQgc2xlZXAoMCk7XG4gIH1cbiAgbWVzc2FnZSA9IFVJX1RJTEVTX0NIQU5HRV9DT01NQU5EKGlkLCBjb21tYW5kKTtcbiAgaWYgKCFkaXNwYXRjaENsaWVudFBydW5NZXNzYWdlKG1lc3NhZ2UpKSB7XG4gICAgY29uc3QgaW5wdXQgPSAoYXdhaXQgJCh0aWxlLCBDLlBhbmVsU2VsZWN0b3IuaW5wdXQpKSBhcyBIVE1MSW5wdXRFbGVtZW50O1xuICAgIGNoYW5nZUlucHV0VmFsdWUoaW5wdXQsIGNvbW1hbmQpO1xuICAgIGlucHV0LmZvcm0hLnJlcXVlc3RTdWJtaXQoKTtcbiAgfVxuICBhd2FpdCAkKHRpbGUsIEMuVGlsZUZyYW1lLmZyYW1lKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gcmVxdWVzdFRpbGUoY29tbWFuZDogc3RyaW5nKSB7XG4gIGNvbnN0IHdpbmRvdyA9IGF3YWl0IHNob3dCdWZmZXIoY29tbWFuZCwgeyBhdXRvU3VibWl0OiB0cnVlIH0pO1xuICBhd2FpdCBzbGVlcCgwKTtcbiAgY29uc3QgYm9keSA9IF8kKHdpbmRvdywgQy5XaW5kb3cuYm9keSk7XG4gIHJldHVybiBib2R5ID8gXyQoYm9keSwgQy5UaWxlLnRpbGUpIDogdW5kZWZpbmVkO1xufVxuXG5mdW5jdGlvbiBzcGxpdEJ1ZmZlcih0aWxlOiBQcnVuVGlsZSkge1xuICBjb25zdCB3aWR0aCA9IHBhcnNlSW50KHRpbGUuY29udGFpbmVyLnN0eWxlLndpZHRoLnJlcGxhY2UoJ3B4JywgJycpLCAxMCk7XG4gIGNvbnN0IGhlaWdodCA9IHBhcnNlSW50KHRpbGUuY29udGFpbmVyLnN0eWxlLmhlaWdodC5yZXBsYWNlKCdweCcsICcnKSwgMTApO1xuICBzZXRCdWZmZXJTaXplKHRpbGUuaWQsIHdpZHRoICsgNDUwLCBoZWlnaHQpO1xuICBjb25zdCBjaGFuZ2VCdXR0b24gPSBfJCQodGlsZS5mcmFtZSwgQy5UaWxlQ29udHJvbHMuY29udHJvbCkuZmluZCh4ID0+IHgudGV4dENvbnRlbnQgPT09ICd8Jyk7XG4gIHZvaWQgY2xpY2tFbGVtZW50KGNoYW5nZUJ1dHRvbik7XG59XG4iXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7O0FBWU8sTUFBQSxjQUFBO0FBQUEsRUFBb0I7QUFBQSxFQUNqQixZQUFBLFNBQUE7QUFHTixVQUFBLEVBQUEsS0FBQSxJQUFBO0FBQ0EsVUFBQSxlQUFBLEtBQUEsVUFBQSxVQUFBLFNBQUEsRUFBQSxPQUFBLElBQUE7QUFDQSxRQUFBLGNBQUE7QUFDRSxjQUFBLGNBQUE7QUFDQSxrQkFBQSxJQUFBO0FBQUEsSUFBZ0IsT0FBQTtBQUVoQixXQUFBLGdCQUFBLGlCQUFBLElBQUE7QUFBQSxJQUEwQztBQUFBLEVBQzVDO0FBQUEsRUFDRixNQUFBLFlBQUEsU0FBQTtBQUdFLFFBQUEsS0FBQSxlQUFBLGFBQUE7QUFDRSxZQUFBLGtCQUFBLEtBQUEsZUFBQSxPQUFBO0FBQUEsSUFBbUQsT0FBQTtBQUVuRCxXQUFBLGdCQUFBLE1BQUEsWUFBQSxPQUFBO0FBQUEsSUFBOEM7QUFFaEQsV0FBQSxNQUFBLGdCQUFBLEtBQUEsZUFBQSxhQUFBLEVBQUEsQ0FBQTtBQUFBLEVBQWlFO0FBRXJFO0FBRUEsU0FBQSxpQkFBQSxNQUFBO0FBQ0UsUUFBQSxnQkFBQSxLQUFBLFVBQUEsVUFBQSxTQUFBLEVBQUEsS0FBQSxLQUFBO0FBQ0EsUUFBQSxXQUFBLEtBQUEsVUFBQSxlQUFBLFVBQUEsU0FBQSxFQUFBLEtBQUEsSUFBQTtBQUNBLFFBQUEsYUFBQSxLQUFBLFVBQUEsZUFBQSxlQUFBLFVBQUEsU0FBQSxFQUFBLE9BQUEsSUFBQTtBQUNBLE1BQUEsQ0FBQSxpQkFBQSxDQUFBLFlBQUEsQ0FBQSxZQUFBO0FBQ0UsV0FBQTtBQUFBLEVBQU87QUFHVCxRQUFBLE9BQUEsS0FBQSxVQUFBO0FBQ0EsUUFBQSxVQUFBLElBQUEsTUFBQSxFQUFBLEtBQUEsS0FBQSxFQUFBLEtBQUEsQ0FBQSxNQUFBLE1BQUEsS0FBQSxTQUFBO0FBQ0EsU0FBQSxHQUFBLFNBQUEsRUFBQSxLQUFBLElBQUE7QUFDRjtBQUVBLGVBQUEsa0JBQUEsTUFBQSxTQUFBO0FBQ0UsUUFBQSxLQUFBLFVBQUEsSUFBQTtBQUNBLE1BQUEsVUFBQSx3QkFBQSxJQUFBLElBQUE7QUFDQSxNQUFBLENBQUEsMEJBQUEsT0FBQSxHQUFBO0FBQ0UsVUFBQSxlQUFBLElBQUEsTUFBQSxFQUFBLGFBQUEsT0FBQSxFQUFBLEtBQUEsQ0FBQSxNQUFBLEVBQUEsZ0JBQUEsR0FBQTtBQUNBLFVBQUEsYUFBQSxZQUFBO0FBQUEsRUFBK0IsT0FBQTtBQUUvQixVQUFBLE1BQUEsQ0FBQTtBQUFBLEVBQWE7QUFFZixZQUFBLHdCQUFBLElBQUEsT0FBQTtBQUNBLE1BQUEsQ0FBQSwwQkFBQSxPQUFBLEdBQUE7QUFDRSxVQUFBLFFBQUEsTUFBQSxFQUFBLE1BQUEsRUFBQSxjQUFBLEtBQUE7QUFDQSxxQkFBQSxPQUFBLE9BQUE7QUFDQSxVQUFBLEtBQUEsY0FBQTtBQUFBLEVBQTBCO0FBRTVCLFFBQUEsRUFBQSxNQUFBLEVBQUEsVUFBQSxLQUFBO0FBQ0Y7QUFFQSxlQUFBLFlBQUEsU0FBQTtBQUNFLFFBQUEsU0FBQSxNQUFBLFdBQUEsU0FBQSxFQUFBLFlBQUEsTUFBQTtBQUNBLFFBQUEsTUFBQSxDQUFBO0FBQ0EsUUFBQSxPQUFBLEdBQUEsUUFBQSxFQUFBLE9BQUEsSUFBQTtBQUNBLFNBQUEsT0FBQSxHQUFBLE1BQUEsRUFBQSxLQUFBLElBQUEsSUFBQTtBQUNGO0FBRUEsU0FBQSxZQUFBLE1BQUE7QUFDRSxRQUFBLFFBQUEsU0FBQSxLQUFBLFVBQUEsTUFBQSxNQUFBLFFBQUEsTUFBQSxFQUFBLEdBQUEsRUFBQTtBQUNBLFFBQUEsU0FBQSxTQUFBLEtBQUEsVUFBQSxNQUFBLE9BQUEsUUFBQSxNQUFBLEVBQUEsR0FBQSxFQUFBO0FBQ0EsZ0JBQUEsS0FBQSxJQUFBLFFBQUEsS0FBQSxNQUFBO0FBQ0EsUUFBQSxlQUFBLElBQUEsS0FBQSxPQUFBLEVBQUEsYUFBQSxPQUFBLEVBQUEsS0FBQSxDQUFBLE1BQUEsRUFBQSxnQkFBQSxHQUFBO0FBQ0EsT0FBQSxhQUFBLFlBQUE7QUFDRjsifQ==
