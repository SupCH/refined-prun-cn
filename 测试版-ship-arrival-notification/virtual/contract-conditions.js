import { contractsStore, isFactionContract } from './contracts.js';
import dayjs from './dayjs.min.js';
import { timestampEachMinute } from './dayjs.js';
import { sumBy } from './sum-by.js';
import { calcMaterialAmountPrice } from './cx.js';
import { binarySearch } from './binary-search.js';
import { map } from './map-values.js';
import { computed } from './runtime-core.esm-bundler.js';
const sortedConditions = computed(() => {
  const active = contractsStore.active.value;
  if (!active) {
    return void 0;
  }
  const conditions = [];
  for (const contract of active) {
    const activeConditions = contract.conditions.filter(x => x.status !== 'FULFILLED');
    for (const condition of activeConditions) {
      conditions.push({
        contract,
        condition,
        isSelf: condition.party === contract.party,
        deadline: calculateDeadline(contract, condition),
        dependencies: condition.dependencies
          .map(id => contract.conditions.find(x => x.id === id))
          .filter(x => x !== void 0),
      });
    }
  }
  conditions.sort((a, b) => a.deadline - b.deadline);
  return conditions;
});
function calculateDeadline(contract, condition) {
  if (condition.type === 'COMEX_PURCHASE_PICKUP') {
    return getLatestDependencyDeadline(contract, condition);
  }
  if (condition.deadline) {
    return condition.deadline.timestamp;
  }
  if (!condition.deadlineDuration) {
    return Number.POSITIVE_INFINITY;
  }
  return getLatestDependencyDeadline(contract, condition) + condition.deadlineDuration.millis;
}
function getLatestDependencyDeadline(contract, condition) {
  let latestDependency = contract.date.timestamp;
  for (const dependency of condition.dependencies) {
    const dependencyCondition = contract.conditions.find(x => x.id === dependency);
    if (dependencyCondition) {
      latestDependency = Math.max(
        latestDependency,
        calculateDeadline(contract, dependencyCondition),
      );
    }
  }
  return latestDependency;
}
const accountingPeriod = dayjs.duration(1, 'week').asMilliseconds();
const currentSplitIndex = computed(() => {
  const sorted = sortedConditions.value;
  if (!sorted) {
    return void 0;
  }
  const currentSplitDate = timestampEachMinute.value + accountingPeriod;
  return binarySearch(currentSplitDate, sorted, x => x.deadline);
});
const currentConditions = computed(() => {
  return sortedConditions.value?.slice(0, currentSplitIndex.value);
});
const selfCurrentConditions = computed(() => {
  return currentConditions.value?.filter(x => x.isSelf);
});
const partnerCurrentConditions = computed(() => {
  return currentConditions.value?.filter(x => !x.isSelf);
});
const nonCurrentConditions = computed(() => {
  return sortedConditions.value?.slice(currentSplitIndex.value);
});
const selfNonCurrentConditions = computed(() => {
  return nonCurrentConditions.value?.filter(x => x.isSelf);
});
const partnerNonCurrentConditions = computed(() => {
  return nonCurrentConditions.value?.filter(x => !x.isSelf);
});
function sumAccountsPayable(conditions) {
  return sumConditions(conditions, ['PAYMENT', 'LOAN_PAYOUT'], x => x.amount.amount);
}
function sumLoanRepayments(conditions) {
  return sumConditions(conditions, ['LOAN_INSTALLMENT'], x => x.repayment.amount);
}
function sumLoanInterest(conditions) {
  const filtered = conditions.value?.filter(
    x =>
      x.condition.type === 'LOAN_INSTALLMENT' &&
      x.dependencies.every(y => y.status === 'FULFILLED'),
  );
  return sumBy(filtered, x => x.condition.interest.amount);
}
function sumDeliveries(conditions) {
  return sumConditions(conditions, ['DELIVERY'], getMaterialQuantityValue);
}
function sumProvisions(conditions) {
  return sumConditions(conditions, ['PROVISION'], getMaterialQuantityValue);
}
function sumFactionProvisions(conditions) {
  const filtered = conditions.value?.filter(
    x => isFactionContract(x.contract) && x.condition.type === 'PROVISION_SHIPMENT',
  );
  return sumBy(filtered, x => getMaterialQuantityValue(x.condition));
}
function sumMaterialsPickup(conditions) {
  return sumConditions(conditions, ['COMEX_PURCHASE_PICKUP'], x => {
    return map(
      [calcMaterialAmountPrice(x.quantity), calcMaterialAmountPrice(x.pickedUp)],
      (quantity, pickedUp) => quantity - pickedUp,
    );
  });
}
function sumShipmentDeliveries(conditions) {
  let total = 0;
  const filtered = conditions.value?.filter(x => x.condition.type === 'DELIVERY_SHIPMENT');
  if (!filtered) {
    return void 0;
  }
  for (const cc of filtered) {
    const pickup = findDependency(cc.contract, cc.condition, 'PICKUP_SHIPMENT');
    if (!pickup) {
      continue;
    }
    const provision = findDependency(cc.contract, pickup, 'PROVISION_SHIPMENT');
    if (provision?.status !== 'FULFILLED' || !provision?.quantity) {
      continue;
    }
    const value = getMaterialQuantityValue(provision);
    if (value === void 0) {
      return void 0;
    }
    total += value;
  }
  return total;
}
function findDependency(contract, condition, type) {
  for (const id of condition.dependencies) {
    const match = contract.conditions.find(x => x.id === id);
    if (match?.type === type) {
      return match;
    }
  }
  return void 0;
}
function sumConditions(conditions, types, property) {
  const filtered = conditions.value?.filter(x => types.includes(x.condition.type));
  return sumBy(filtered, x => property(x.condition));
}
function getMaterialQuantityValue(condition) {
  return calcMaterialAmountPrice(condition.quantity);
}
export {
  currentConditions,
  nonCurrentConditions,
  partnerCurrentConditions,
  partnerNonCurrentConditions,
  selfCurrentConditions,
  selfNonCurrentConditions,
  sumAccountsPayable,
  sumDeliveries,
  sumFactionProvisions,
  sumLoanInterest,
  sumLoanRepayments,
  sumMaterialsPickup,
  sumProvisions,
  sumShipmentDeliveries,
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29udHJhY3QtY29uZGl0aW9ucy5qcyIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2NvcmUvYmFsYW5jZS9jb250cmFjdC1jb25kaXRpb25zLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGNvbnRyYWN0c1N0b3JlLCBpc0ZhY3Rpb25Db250cmFjdCB9IGZyb20gJ0BzcmMvaW5mcmFzdHJ1Y3R1cmUvcHJ1bi1hcGkvZGF0YS9jb250cmFjdHMnO1xuaW1wb3J0IGRheWpzIGZyb20gJ2RheWpzJztcbmltcG9ydCB7IHRpbWVzdGFtcEVhY2hNaW51dGUgfSBmcm9tICdAc3JjL3V0aWxzL2RheWpzJztcbmltcG9ydCB7IHN1bUJ5IH0gZnJvbSAnQHNyYy91dGlscy9zdW0tYnknO1xuaW1wb3J0IHsgY2FsY01hdGVyaWFsQW1vdW50UHJpY2UgfSBmcm9tICdAc3JjL2luZnJhc3RydWN0dXJlL2Zpby9jeCc7XG5pbXBvcnQgeyBiaW5hcnlTZWFyY2ggfSBmcm9tICdAc3JjL3V0aWxzL2JpbmFyeS1zZWFyY2gnO1xuaW1wb3J0IHsgbWFwIH0gZnJvbSAnQHNyYy91dGlscy9tYXAtdmFsdWVzJztcblxuaW50ZXJmYWNlIENvbnRyYWN0Q29uZGl0aW9uIHtcbiAgY29udHJhY3Q6IFBydW5BcGkuQ29udHJhY3Q7XG4gIGNvbmRpdGlvbjogUHJ1bkFwaS5Db250cmFjdENvbmRpdGlvbjtcbiAgaXNTZWxmOiBib29sZWFuO1xuICBkZWFkbGluZTogbnVtYmVyO1xuICBkZXBlbmRlbmNpZXM6IFBydW5BcGkuQ29udHJhY3RDb25kaXRpb25bXTtcbn1cblxuY29uc3Qgc29ydGVkQ29uZGl0aW9ucyA9IGNvbXB1dGVkKCgpID0+IHtcbiAgY29uc3QgYWN0aXZlID0gY29udHJhY3RzU3RvcmUuYWN0aXZlLnZhbHVlO1xuICBpZiAoIWFjdGl2ZSkge1xuICAgIHJldHVybiB1bmRlZmluZWQ7XG4gIH1cbiAgY29uc3QgY29uZGl0aW9uczogQ29udHJhY3RDb25kaXRpb25bXSA9IFtdO1xuICBmb3IgKGNvbnN0IGNvbnRyYWN0IG9mIGFjdGl2ZSkge1xuICAgIGNvbnN0IGFjdGl2ZUNvbmRpdGlvbnMgPSBjb250cmFjdC5jb25kaXRpb25zLmZpbHRlcih4ID0+IHguc3RhdHVzICE9PSAnRlVMRklMTEVEJyk7XG4gICAgZm9yIChjb25zdCBjb25kaXRpb24gb2YgYWN0aXZlQ29uZGl0aW9ucykge1xuICAgICAgY29uZGl0aW9ucy5wdXNoKHtcbiAgICAgICAgY29udHJhY3QsXG4gICAgICAgIGNvbmRpdGlvbixcbiAgICAgICAgaXNTZWxmOiBjb25kaXRpb24ucGFydHkgPT09IGNvbnRyYWN0LnBhcnR5LFxuICAgICAgICBkZWFkbGluZTogY2FsY3VsYXRlRGVhZGxpbmUoY29udHJhY3QsIGNvbmRpdGlvbiksXG4gICAgICAgIGRlcGVuZGVuY2llczogY29uZGl0aW9uLmRlcGVuZGVuY2llc1xuICAgICAgICAgIC5tYXAoaWQgPT4gY29udHJhY3QuY29uZGl0aW9ucy5maW5kKHggPT4geC5pZCA9PT0gaWQpKVxuICAgICAgICAgIC5maWx0ZXIoeCA9PiB4ICE9PSB1bmRlZmluZWQpLFxuICAgICAgfSk7XG4gICAgfVxuICB9XG4gIGNvbmRpdGlvbnMuc29ydCgoYSwgYikgPT4gYS5kZWFkbGluZSAtIGIuZGVhZGxpbmUpO1xuICByZXR1cm4gY29uZGl0aW9ucztcbn0pO1xuXG5mdW5jdGlvbiBjYWxjdWxhdGVEZWFkbGluZShjb250cmFjdDogUHJ1bkFwaS5Db250cmFjdCwgY29uZGl0aW9uOiBQcnVuQXBpLkNvbnRyYWN0Q29uZGl0aW9uKSB7XG4gIGlmIChjb25kaXRpb24udHlwZSA9PT0gJ0NPTUVYX1BVUkNIQVNFX1BJQ0tVUCcpIHtcbiAgICAvLyBUaGUgQ09NRVhfUFVSQ0hBU0VfUElDS1VQIGNvbmRpdGlvbiBoYXMgdW5pcXVlIGhhbmRsaW5nOlxuICAgIC8vIE9uY2UgYWxsIGl0cyBkZXBlbmRlbmNpZXMgYXJlIGZ1bGZpbGxlZCxcbiAgICAvLyB0aGUgcGxheWVyIG5lZWRzIHRvIHBpY2sgdXAgdGhlIG1hdGVyaWFscyB1c2luZyB0aGlzIGNvbmRpdGlvbi5cbiAgICAvLyBGb3IgZGV0ZXJtaW5pbmcgdGhlIGRlYWRsaW5lIG9mIHRoZSBDT01FWF9QVVJDSEFTRV9QSUNLVVAgY29uZGl0aW9uLFxuICAgIC8vIHdlIHdpbGwgdXNlIHRoZSBsYXRlc3QgZGVhZGxpbmUgYW1vbmcgaXRzIGRlcGVuZGVuY2llcy5cbiAgICAvLyBUaGlzIGlzIGJlY2F1c2UgdGhlIG1hdGVyaWFscyBjYW4gYmUgcGlja2VkIHVwIGF0IGFueSB0aW1lLFxuICAgIC8vIG1ha2luZyB0aGUgQ09NRVhfUFVSQ0hBU0VfUElDS1VQJ3Mgb3duIGRlYWRsaW5lIGlycmVsZXZhbnQuXG4gICAgcmV0dXJuIGdldExhdGVzdERlcGVuZGVuY3lEZWFkbGluZShjb250cmFjdCwgY29uZGl0aW9uKTtcbiAgfVxuXG4gIGlmIChjb25kaXRpb24uZGVhZGxpbmUpIHtcbiAgICByZXR1cm4gY29uZGl0aW9uLmRlYWRsaW5lLnRpbWVzdGFtcDtcbiAgfVxuXG4gIGlmICghY29uZGl0aW9uLmRlYWRsaW5lRHVyYXRpb24pIHtcbiAgICByZXR1cm4gTnVtYmVyLlBPU0lUSVZFX0lORklOSVRZO1xuICB9XG5cbiAgcmV0dXJuIGdldExhdGVzdERlcGVuZGVuY3lEZWFkbGluZShjb250cmFjdCwgY29uZGl0aW9uKSArIGNvbmRpdGlvbi5kZWFkbGluZUR1cmF0aW9uLm1pbGxpcztcbn1cblxuZnVuY3Rpb24gZ2V0TGF0ZXN0RGVwZW5kZW5jeURlYWRsaW5lKFxuICBjb250cmFjdDogUHJ1bkFwaS5Db250cmFjdCxcbiAgY29uZGl0aW9uOiBQcnVuQXBpLkNvbnRyYWN0Q29uZGl0aW9uLFxuKSB7XG4gIGxldCBsYXRlc3REZXBlbmRlbmN5ID0gY29udHJhY3QuZGF0ZS50aW1lc3RhbXA7XG4gIGZvciAoY29uc3QgZGVwZW5kZW5jeSBvZiBjb25kaXRpb24uZGVwZW5kZW5jaWVzKSB7XG4gICAgY29uc3QgZGVwZW5kZW5jeUNvbmRpdGlvbiA9IGNvbnRyYWN0LmNvbmRpdGlvbnMuZmluZCh4ID0+IHguaWQgPT09IGRlcGVuZGVuY3kpO1xuICAgIGlmIChkZXBlbmRlbmN5Q29uZGl0aW9uKSB7XG4gICAgICBsYXRlc3REZXBlbmRlbmN5ID0gTWF0aC5tYXgoXG4gICAgICAgIGxhdGVzdERlcGVuZGVuY3ksXG4gICAgICAgIGNhbGN1bGF0ZURlYWRsaW5lKGNvbnRyYWN0LCBkZXBlbmRlbmN5Q29uZGl0aW9uKSxcbiAgICAgICk7XG4gICAgfVxuICB9XG4gIHJldHVybiBsYXRlc3REZXBlbmRlbmN5O1xufVxuXG5jb25zdCBhY2NvdW50aW5nUGVyaW9kID0gZGF5anMuZHVyYXRpb24oMSwgJ3dlZWsnKS5hc01pbGxpc2Vjb25kcygpO1xuXG5jb25zdCBjdXJyZW50U3BsaXRJbmRleCA9IGNvbXB1dGVkKCgpID0+IHtcbiAgY29uc3Qgc29ydGVkID0gc29ydGVkQ29uZGl0aW9ucy52YWx1ZTtcbiAgaWYgKCFzb3J0ZWQpIHtcbiAgICByZXR1cm4gdW5kZWZpbmVkO1xuICB9XG4gIGNvbnN0IGN1cnJlbnRTcGxpdERhdGUgPSB0aW1lc3RhbXBFYWNoTWludXRlLnZhbHVlICsgYWNjb3VudGluZ1BlcmlvZDtcbiAgcmV0dXJuIGJpbmFyeVNlYXJjaChjdXJyZW50U3BsaXREYXRlLCBzb3J0ZWQsIHggPT4geC5kZWFkbGluZSk7XG59KTtcblxuZXhwb3J0IGNvbnN0IGN1cnJlbnRDb25kaXRpb25zID0gY29tcHV0ZWQoKCkgPT4ge1xuICByZXR1cm4gc29ydGVkQ29uZGl0aW9ucy52YWx1ZT8uc2xpY2UoMCwgY3VycmVudFNwbGl0SW5kZXgudmFsdWUpO1xufSk7XG5cbmV4cG9ydCBjb25zdCBzZWxmQ3VycmVudENvbmRpdGlvbnMgPSBjb21wdXRlZCgoKSA9PiB7XG4gIHJldHVybiBjdXJyZW50Q29uZGl0aW9ucy52YWx1ZT8uZmlsdGVyKHggPT4geC5pc1NlbGYpO1xufSk7XG5cbmV4cG9ydCBjb25zdCBwYXJ0bmVyQ3VycmVudENvbmRpdGlvbnMgPSBjb21wdXRlZCgoKSA9PiB7XG4gIHJldHVybiBjdXJyZW50Q29uZGl0aW9ucy52YWx1ZT8uZmlsdGVyKHggPT4gIXguaXNTZWxmKTtcbn0pO1xuXG5leHBvcnQgY29uc3Qgbm9uQ3VycmVudENvbmRpdGlvbnMgPSBjb21wdXRlZCgoKSA9PiB7XG4gIHJldHVybiBzb3J0ZWRDb25kaXRpb25zLnZhbHVlPy5zbGljZShjdXJyZW50U3BsaXRJbmRleC52YWx1ZSk7XG59KTtcblxuZXhwb3J0IGNvbnN0IHNlbGZOb25DdXJyZW50Q29uZGl0aW9ucyA9IGNvbXB1dGVkKCgpID0+IHtcbiAgcmV0dXJuIG5vbkN1cnJlbnRDb25kaXRpb25zLnZhbHVlPy5maWx0ZXIoeCA9PiB4LmlzU2VsZik7XG59KTtcblxuZXhwb3J0IGNvbnN0IHBhcnRuZXJOb25DdXJyZW50Q29uZGl0aW9ucyA9IGNvbXB1dGVkKCgpID0+IHtcbiAgcmV0dXJuIG5vbkN1cnJlbnRDb25kaXRpb25zLnZhbHVlPy5maWx0ZXIoeCA9PiAheC5pc1NlbGYpO1xufSk7XG5cbnR5cGUgTWF5YmVDb25kaXRpb25zID0gUmVmPENvbnRyYWN0Q29uZGl0aW9uW10gfCB1bmRlZmluZWQ+O1xuXG5leHBvcnQgZnVuY3Rpb24gc3VtQWNjb3VudHNQYXlhYmxlKGNvbmRpdGlvbnM6IE1heWJlQ29uZGl0aW9ucykge1xuICByZXR1cm4gc3VtQ29uZGl0aW9ucyhjb25kaXRpb25zLCBbJ1BBWU1FTlQnLCAnTE9BTl9QQVlPVVQnXSwgeCA9PiB4LmFtb3VudCEuYW1vdW50KTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHN1bUxvYW5SZXBheW1lbnRzKGNvbmRpdGlvbnM6IE1heWJlQ29uZGl0aW9ucykge1xuICByZXR1cm4gc3VtQ29uZGl0aW9ucyhjb25kaXRpb25zLCBbJ0xPQU5fSU5TVEFMTE1FTlQnXSwgeCA9PiB4LnJlcGF5bWVudCEuYW1vdW50KTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHN1bUxvYW5JbnRlcmVzdChjb25kaXRpb25zOiBNYXliZUNvbmRpdGlvbnMpIHtcbiAgY29uc3QgZmlsdGVyZWQgPSBjb25kaXRpb25zLnZhbHVlPy5maWx0ZXIoXG4gICAgeCA9PlxuICAgICAgeC5jb25kaXRpb24udHlwZSA9PT0gJ0xPQU5fSU5TVEFMTE1FTlQnICYmXG4gICAgICB4LmRlcGVuZGVuY2llcy5ldmVyeSh5ID0+IHkuc3RhdHVzID09PSAnRlVMRklMTEVEJyksXG4gICk7XG4gIHJldHVybiBzdW1CeShmaWx0ZXJlZCwgeCA9PiB4LmNvbmRpdGlvbi5pbnRlcmVzdCEuYW1vdW50KTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHN1bURlbGl2ZXJpZXMoY29uZGl0aW9uczogTWF5YmVDb25kaXRpb25zKSB7XG4gIHJldHVybiBzdW1Db25kaXRpb25zKGNvbmRpdGlvbnMsIFsnREVMSVZFUlknXSwgZ2V0TWF0ZXJpYWxRdWFudGl0eVZhbHVlKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHN1bVByb3Zpc2lvbnMoY29uZGl0aW9uczogTWF5YmVDb25kaXRpb25zKSB7XG4gIHJldHVybiBzdW1Db25kaXRpb25zKGNvbmRpdGlvbnMsIFsnUFJPVklTSU9OJ10sIGdldE1hdGVyaWFsUXVhbnRpdHlWYWx1ZSk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBzdW1GYWN0aW9uUHJvdmlzaW9ucyhjb25kaXRpb25zOiBNYXliZUNvbmRpdGlvbnMpIHtcbiAgLy8gRmFjdGlvbiBMb2dpc3RpY3MgY29udHJhY3RzIHJlcXVlc3QgbWF0ZXJpYWxzIHZpYSBQUk9WSVNJT05fU0hJUE1FTlRcbiAgLy8gY29udHJhY3QgY29uZGl0aW9ucy4gQ291bnQgdGhlbSBhcyBsaWFiaWxpdGllcy5cbiAgY29uc3QgZmlsdGVyZWQgPSBjb25kaXRpb25zLnZhbHVlPy5maWx0ZXIoXG4gICAgeCA9PiBpc0ZhY3Rpb25Db250cmFjdCh4LmNvbnRyYWN0KSAmJiB4LmNvbmRpdGlvbi50eXBlID09PSAnUFJPVklTSU9OX1NISVBNRU5UJyxcbiAgKTtcbiAgcmV0dXJuIHN1bUJ5KGZpbHRlcmVkLCB4ID0+IGdldE1hdGVyaWFsUXVhbnRpdHlWYWx1ZSh4LmNvbmRpdGlvbikpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gc3VtTWF0ZXJpYWxzUGlja3VwKGNvbmRpdGlvbnM6IE1heWJlQ29uZGl0aW9ucykge1xuICByZXR1cm4gc3VtQ29uZGl0aW9ucyhjb25kaXRpb25zLCBbJ0NPTUVYX1BVUkNIQVNFX1BJQ0tVUCddLCB4ID0+IHtcbiAgICByZXR1cm4gbWFwKFxuICAgICAgW2NhbGNNYXRlcmlhbEFtb3VudFByaWNlKHgucXVhbnRpdHkhKSwgY2FsY01hdGVyaWFsQW1vdW50UHJpY2UoeC5waWNrZWRVcCEpXSxcbiAgICAgIChxdWFudGl0eSwgcGlja2VkVXApID0+IHF1YW50aXR5IC0gcGlja2VkVXAsXG4gICAgKTtcbiAgfSk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBzdW1TaGlwbWVudERlbGl2ZXJpZXMoY29uZGl0aW9uczogTWF5YmVDb25kaXRpb25zKSB7XG4gIGxldCB0b3RhbCA9IDA7XG4gIGNvbnN0IGZpbHRlcmVkID0gY29uZGl0aW9ucy52YWx1ZT8uZmlsdGVyKHggPT4geC5jb25kaXRpb24udHlwZSA9PT0gJ0RFTElWRVJZX1NISVBNRU5UJyk7XG4gIGlmICghZmlsdGVyZWQpIHtcbiAgICByZXR1cm4gdW5kZWZpbmVkO1xuICB9XG4gIGZvciAoY29uc3QgY2Mgb2YgZmlsdGVyZWQpIHtcbiAgICBjb25zdCBwaWNrdXAgPSBmaW5kRGVwZW5kZW5jeShjYy5jb250cmFjdCwgY2MuY29uZGl0aW9uLCAnUElDS1VQX1NISVBNRU5UJyk7XG4gICAgaWYgKCFwaWNrdXApIHtcbiAgICAgIGNvbnRpbnVlO1xuICAgIH1cbiAgICBjb25zdCBwcm92aXNpb24gPSBmaW5kRGVwZW5kZW5jeShjYy5jb250cmFjdCwgcGlja3VwLCAnUFJPVklTSU9OX1NISVBNRU5UJyk7XG4gICAgaWYgKHByb3Zpc2lvbj8uc3RhdHVzICE9PSAnRlVMRklMTEVEJyB8fCAhcHJvdmlzaW9uPy5xdWFudGl0eSkge1xuICAgICAgY29udGludWU7XG4gICAgfVxuICAgIGNvbnN0IHZhbHVlID0gZ2V0TWF0ZXJpYWxRdWFudGl0eVZhbHVlKHByb3Zpc2lvbik7XG4gICAgaWYgKHZhbHVlID09PSB1bmRlZmluZWQpIHtcbiAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgfVxuICAgIHRvdGFsICs9IHZhbHVlO1xuICB9XG4gIHJldHVybiB0b3RhbDtcbn1cblxuZnVuY3Rpb24gZmluZERlcGVuZGVuY3koXG4gIGNvbnRyYWN0OiBQcnVuQXBpLkNvbnRyYWN0LFxuICBjb25kaXRpb246IFBydW5BcGkuQ29udHJhY3RDb25kaXRpb24sXG4gIHR5cGU6IFBydW5BcGkuQ29udHJhY3RDb25kaXRpb25UeXBlLFxuKSB7XG4gIGZvciAoY29uc3QgaWQgb2YgY29uZGl0aW9uLmRlcGVuZGVuY2llcykge1xuICAgIGNvbnN0IG1hdGNoID0gY29udHJhY3QuY29uZGl0aW9ucy5maW5kKHggPT4geC5pZCA9PT0gaWQpO1xuICAgIGlmIChtYXRjaD8udHlwZSA9PT0gdHlwZSkge1xuICAgICAgcmV0dXJuIG1hdGNoO1xuICAgIH1cbiAgfVxuICByZXR1cm4gdW5kZWZpbmVkO1xufVxuXG5mdW5jdGlvbiBzdW1Db25kaXRpb25zKFxuICBjb25kaXRpb25zOiBNYXliZUNvbmRpdGlvbnMsXG4gIHR5cGVzOiBQcnVuQXBpLkNvbnRyYWN0Q29uZGl0aW9uVHlwZVtdLFxuICBwcm9wZXJ0eTogKGl0ZW06IFBydW5BcGkuQ29udHJhY3RDb25kaXRpb24pID0+IG51bWJlciB8IHVuZGVmaW5lZCxcbikge1xuICBjb25zdCBmaWx0ZXJlZCA9IGNvbmRpdGlvbnMudmFsdWU/LmZpbHRlcih4ID0+IHR5cGVzLmluY2x1ZGVzKHguY29uZGl0aW9uLnR5cGUpKTtcbiAgcmV0dXJuIHN1bUJ5KGZpbHRlcmVkLCB4ID0+IHByb3BlcnR5KHguY29uZGl0aW9uKSk7XG59XG5cbmZ1bmN0aW9uIGdldE1hdGVyaWFsUXVhbnRpdHlWYWx1ZShjb25kaXRpb246IFBydW5BcGkuQ29udHJhY3RDb25kaXRpb24pIHtcbiAgcmV0dXJuIGNhbGNNYXRlcmlhbEFtb3VudFByaWNlKGNvbmRpdGlvbi5xdWFudGl0eSEpO1xufVxuIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7O0FBZ0JBLE1BQUEsbUJBQUEsU0FBQSxNQUFBO0FBQ0UsUUFBQSxTQUFBLGVBQUEsT0FBQTtBQUNBLE1BQUEsQ0FBQSxRQUFBO0FBQ0UsV0FBQTtBQUFBLEVBQU87QUFFVCxRQUFBLGFBQUEsQ0FBQTtBQUNBLGFBQUEsWUFBQSxRQUFBO0FBQ0UsVUFBQSxtQkFBQSxTQUFBLFdBQUEsT0FBQSxDQUFBLE1BQUEsRUFBQSxXQUFBLFdBQUE7QUFDQSxlQUFBLGFBQUEsa0JBQUE7QUFDRSxpQkFBQSxLQUFBO0FBQUEsUUFBZ0I7QUFBQSxRQUNkO0FBQUEsUUFDQSxRQUFBLFVBQUEsVUFBQSxTQUFBO0FBQUEsUUFDcUMsVUFBQSxrQkFBQSxVQUFBLFNBQUE7QUFBQSxRQUNVLGNBQUEsVUFBQSxhQUFBLElBQUEsQ0FBQSxPQUFBLFNBQUEsV0FBQSxLQUFBLENBQUEsTUFBQSxFQUFBLE9BQUEsRUFBQSxDQUFBLEVBQUEsT0FBQSxDQUFBLE1BQUEsTUFBQSxNQUFBO0FBQUEsTUFHakIsQ0FBQTtBQUFBLElBQy9CO0FBQUEsRUFDSDtBQUVGLGFBQUEsS0FBQSxDQUFBLEdBQUEsTUFBQSxFQUFBLFdBQUEsRUFBQSxRQUFBO0FBQ0EsU0FBQTtBQUNGLENBQUE7QUFFQSxTQUFBLGtCQUFBLFVBQUEsV0FBQTtBQUNFLE1BQUEsVUFBQSxTQUFBLHlCQUFBO0FBUUUsV0FBQSw0QkFBQSxVQUFBLFNBQUE7QUFBQSxFQUFzRDtBQUd4RCxNQUFBLFVBQUEsVUFBQTtBQUNFLFdBQUEsVUFBQSxTQUFBO0FBQUEsRUFBMEI7QUFHNUIsTUFBQSxDQUFBLFVBQUEsa0JBQUE7QUFDRSxXQUFBLE9BQUE7QUFBQSxFQUFjO0FBR2hCLFNBQUEsNEJBQUEsVUFBQSxTQUFBLElBQUEsVUFB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
