import './config.js';
import { Logger } from './logger.js';
import { warehousesStore } from './warehouses.js';
import { exchangesStore } from './exchanges.js';
import { storagesStore } from './storage.js';
import { act } from './act-registry.js';
import { t } from './index5.js';
const AssertionError = new Error('Assertion failed');
class StepGenerator {
  constructor(options) {
    this.options = options;
  }
  get log() {
    return this.options.log;
  }
  async generateSteps(pkg, config) {
    const state = generateState();
    const steps = [];
    let fail = false;
    for (const action of pkg.actions) {
      const info = act.getActionInfo(action.type);
      if (!info) {
        continue;
      }
      const actionConfig = config.actions[action.name] ?? {};
      const log = new Logger((tag, message) =>
        this.log.logMessage(tag, `[${action.name}] ${message}`),
      );
      try {
        await info.generateSteps({
          data: action,
          config: actionConfig,
          log,
          fail: message => {
            if (message) {
              log.error(message);
            }
            fail = true;
          },
          assert: (condition, message) => {
            if (!condition) {
              log.error(message);
              throw AssertionError;
            }
          },
          emitStep: step => steps.push(step),
          getMaterialGroup: async name => await this.getMaterialGroup(pkg, config, name),
          state,
        });
      } catch (e) {
        if (e !== AssertionError) {
          this.log.runtimeError(e);
        }
        fail = true;
      }
      if (fail) {
        break;
      }
    }
    if (steps.length === 0 && !fail) {
      this.log.info(t('act.noActionsGenerated'));
    }
    return { steps, fail };
  }
  async getMaterialGroup(pkg, config, name) {
    if (!name) {
      this.log.error('Missing material group');
    }
    const group = pkg.groups.find(x => x.name === name);
    if (!group) {
      this.log.error('Unrecognized material group');
      return void 0;
    }
    const info = act.getMaterialGroupInfo(group.type);
    if (!info) {
      this.log.error('Unrecognized material group type');
      return void 0;
    }
    this.options.onStatusChanged(`Generating material bill for ${group.name}...`);
    const groupConfig = config.materialGroups[name] ?? {};
    return await info.generateMaterialBill({
      data: group,
      config: groupConfig,
      log: new Logger((tag, message) => this.log.logMessage(tag, `[${group.name}] ${message}`)),
      setStatus: status => this.options.onStatusChanged(status),
    });
  }
}
function generateState() {
  const war = {};
  for (const ticker of ['AI1', 'CI1', 'CI2', 'IC1', 'NC1', 'NC2']) {
    war[ticker] = {};
    const naturalId = exchangesStore.getNaturalIdFromCode(ticker);
    const warehouse = warehousesStore.getByEntityNaturalId(naturalId);
    const inv = storagesStore.getById(warehouse?.storeId);
    if (inv) {
      for (const mat of inv.items) {
        const quantity = mat.quantity;
        if (quantity) {
          war[ticker][quantity.material.ticker] = quantity.amount;
        }
      }
    }
  }
  return {
    WAR: war,
  };
}
export { StepGenerator };
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RlcC1nZW5lcmF0b3IuanMiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9mZWF0dXJlcy9YSVQvQUNUL3J1bm5lci9zdGVwLWdlbmVyYXRvci50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBY3Rpb25QYWNrYWdlQ29uZmlnLCBBY3Rpb25TdGVwIH0gZnJvbSAnQHNyYy9mZWF0dXJlcy9YSVQvQUNUL3NoYXJlZC10eXBlcyc7XG5pbXBvcnQgeyBMb2dnZXIgfSBmcm9tICdAc3JjL2ZlYXR1cmVzL1hJVC9BQ1QvcnVubmVyL2xvZ2dlcic7XG5pbXBvcnQgeyB3YXJlaG91c2VzU3RvcmUgfSBmcm9tICdAc3JjL2luZnJhc3RydWN0dXJlL3BydW4tYXBpL2RhdGEvd2FyZWhvdXNlcyc7XG5pbXBvcnQgeyBleGNoYW5nZXNTdG9yZSB9IGZyb20gJ0BzcmMvaW5mcmFzdHJ1Y3R1cmUvcHJ1bi1hcGkvZGF0YS9leGNoYW5nZXMnO1xuaW1wb3J0IHsgc3RvcmFnZXNTdG9yZSB9IGZyb20gJ0BzcmMvaW5mcmFzdHJ1Y3R1cmUvcHJ1bi1hcGkvZGF0YS9zdG9yYWdlJztcbmltcG9ydCB7IGFjdCB9IGZyb20gJ0BzcmMvZmVhdHVyZXMvWElUL0FDVC9hY3QtcmVnaXN0cnknO1xuaW1wb3J0IHsgdCB9IGZyb20gJ0BzcmMvaW5mcmFzdHJ1Y3R1cmUvaTE4bic7XG5cbmludGVyZmFjZSBTdGVwR2VuZXJhdG9yT3B0aW9ucyB7XG4gIGxvZzogTG9nZ2VyO1xuICBvblN0YXR1c0NoYW5nZWQ6IChzdGF0dXM6IHN0cmluZykgPT4gdm9pZDtcbn1cblxuY29uc3QgQXNzZXJ0aW9uRXJyb3IgPSBuZXcgRXJyb3IoJ0Fzc2VydGlvbiBmYWlsZWQnKTtcblxuZXhwb3J0IGNsYXNzIFN0ZXBHZW5lcmF0b3Ige1xuICBjb25zdHJ1Y3Rvcihwcml2YXRlIG9wdGlvbnM6IFN0ZXBHZW5lcmF0b3JPcHRpb25zKSB7fVxuXG4gIGdldCBsb2coKSB7XG4gICAgcmV0dXJuIHRoaXMub3B0aW9ucy5sb2c7XG4gIH1cblxuICBhc3luYyBnZW5lcmF0ZVN0ZXBzKHBrZzogVXNlckRhdGEuQWN0aW9uUGFja2FnZURhdGEsIGNvbmZpZzogQWN0aW9uUGFja2FnZUNvbmZpZykge1xuICAgIGNvbnN0IHN0YXRlID0gZ2VuZXJhdGVTdGF0ZSgpO1xuICAgIGNvbnN0IHN0ZXBzID0gW10gYXMgQWN0aW9uU3RlcFtdO1xuICAgIGxldCBmYWlsID0gZmFsc2U7XG4gICAgZm9yIChjb25zdCBhY3Rpb24gb2YgcGtnLmFjdGlvbnMpIHtcbiAgICAgIGNvbnN0IGluZm8gPSBhY3QuZ2V0QWN0aW9uSW5mbyhhY3Rpb24udHlwZSk7XG4gICAgICBpZiAoIWluZm8pIHtcbiAgICAgICAgY29udGludWU7XG4gICAgICB9XG4gICAgICBjb25zdCBhY3Rpb25Db25maWcgPSBjb25maWcuYWN0aW9uc1thY3Rpb24ubmFtZSFdID8/IHt9O1xuICAgICAgY29uc3QgbG9nID0gbmV3IExvZ2dlcigodGFnLCBtZXNzYWdlKSA9PlxuICAgICAgICB0aGlzLmxvZy5sb2dNZXNzYWdlKHRhZywgYFske2FjdGlvbi5uYW1lfV0gJHttZXNzYWdlfWApLFxuICAgICAgKTtcbiAgICAgIHRyeSB7XG4gICAgICAgIGF3YWl0IGluZm8uZ2VuZXJhdGVTdGVwcyh7XG4gICAgICAgICAgZGF0YTogYWN0aW9uLFxuICAgICAgICAgIGNvbmZpZzogYWN0aW9uQ29uZmlnLFxuICAgICAgICAgIGxvZyxcbiAgICAgICAgICBmYWlsOiBtZXNzYWdlID0+IHtcbiAgICAgICAgICAgIGlmIChtZXNzYWdlKSB7XG4gICAgICAgICAgICAgIGxvZy5lcnJvcihtZXNzYWdlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGZhaWwgPSB0cnVlO1xuICAgICAgICAgIH0sXG4gICAgICAgICAgYXNzZXJ0OiAoY29uZGl0aW9uLCBtZXNzYWdlKSA9PiB7XG4gICAgICAgICAgICBpZiAoIWNvbmRpdGlvbikge1xuICAgICAgICAgICAgICBsb2cuZXJyb3IobWVzc2FnZSk7XG4gICAgICAgICAgICAgIHRocm93IEFzc2VydGlvbkVycm9yO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH0sXG4gICAgICAgICAgZW1pdFN0ZXA6IHN0ZXAgPT4gc3RlcHMucHVzaChzdGVwKSxcbiAgICAgICAgICBnZXRNYXRlcmlhbEdyb3VwOiBhc3luYyBuYW1lID0+IGF3YWl0IHRoaXMuZ2V0TWF0ZXJpYWxHcm91cChwa2csIGNvbmZpZywgbmFtZSksXG4gICAgICAgICAgc3RhdGUsXG4gICAgICAgIH0pO1xuICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICBpZiAoZSAhPT0gQXNzZXJ0aW9uRXJyb3IpIHtcbiAgICAgICAgICB0aGlzLmxvZy5ydW50aW1lRXJyb3IoZSk7XG4gICAgICAgIH1cbiAgICAgICAgZmFpbCA9IHRydWU7XG4gICAgICB9XG5cbiAgICAgIGlmIChmYWlsKSB7XG4gICAgICAgIGJyZWFrO1xuICAgICAgfVxuICAgIH1cbiAgICBpZiAoc3RlcHMubGVuZ3RoID09PSAwICYmICFmYWlsKSB7XG4gICAgICB0aGlzLmxvZy5pbmZvKHQoJ2FjdC5ub0FjdGlvbnNHZW5lcmF0ZWQnKSk7XG4gICAgfVxuICAgIHJldHVybiB7IHN0ZXBzLCBmYWlsIH07XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIGdldE1hdGVyaWFsR3JvdXAoXG4gICAgcGtnOiBVc2VyRGF0YS5BY3Rpb25QYWNrYWdlRGF0YSxcbiAgICBjb25maWc6IEFjdGlvblBhY2thZ2VDb25maWcsXG4gICAgbmFtZTogc3RyaW5nIHwgdW5kZWZpbmVkLFxuICApIHtcbiAgICBpZiAoIW5hbWUpIHtcbiAgICAgIHRoaXMubG9nLmVycm9yKCdNaXNzaW5nIG1hdGVyaWFsIGdyb3VwJyk7XG4gICAgfVxuICAgIGNvbnN0IGdyb3VwID0gcGtnLmdyb3Vwcy5maW5kKHggPT4geC5uYW1lID09PSBuYW1lKTtcbiAgICBpZiAoIWdyb3VwKSB7XG4gICAgICB0aGlzLmxvZy5lcnJvcignVW5yZWNvZ25pemVkIG1hdGVyaWFsIGdyb3VwJyk7XG4gICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgIH1cblxuICAgIGNvbnN0IGluZm8gPSBhY3QuZ2V0TWF0ZXJpYWxHcm91cEluZm8oZ3JvdXAudHlwZSk7XG4gICAgaWYgKCFpbmZvKSB7XG4gICAgICB0aGlzLmxvZy5lcnJvcignVW5yZWNvZ25pemVkIG1hdGVyaWFsIGdyb3VwIHR5cGUnKTtcbiAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgfVxuXG4gICAgdGhpcy5vcHRpb25zLm9uU3RhdHVzQ2hhbmdlZChgR2VuZXJhdGluZyBtYXRlcmlhbCBiaWxsIGZvciAke2dyb3VwLm5hbWV9Li4uYCk7XG4gICAgY29uc3QgZ3JvdXBDb25maWcgPSBjb25maWcubWF0ZXJpYWxHcm91cHNbbmFtZSFdID8/IHt9O1xuICAgIHJldHVybiBhd2FpdCBpbmZvLmdlbmVyYXRlTWF0ZXJpYWxCaWxsKHtcbiAgICAgIGRhdGE6IGdyb3VwLFxuICAgICAgY29uZmlnOiBncm91cENvbmZpZyxcbiAgICAgIGxvZzogbmV3IExvZ2dlcigodGFnLCBtZXNzYWdlKSA9PiB0aGlzLmxvZy5sb2dNZXNzYWdlKHRhZywgYFske2dyb3VwLm5hbWV9XSAke21lc3NhZ2V9YCkpLFxuICAgICAgc2V0U3RhdHVzOiBzdGF0dXMgPT4gdGhpcy5vcHRpb25zLm9uU3RhdHVzQ2hhbmdlZChzdGF0dXMpLFxuICAgIH0pO1xuICB9XG59XG5cbmZ1bmN0aW9uIGdlbmVyYXRlU3RhdGUoKSB7XG4gIGNvbnN0IHdhciA9IHt9IGFzIFJlY29yZDxzdHJpbmcsIFJlY29yZDxzdHJpbmcsIG51bWJlcj4+O1xuICBmb3IgKGNvbnN0IHRpY2tlciBvZiBbJ0FJMScsICdDSTEnLCAnQ0kyJywgJ0lDMScsICdOQzEnLCAnTkMyJ10pIHtcbiAgICB3YXJbdGlja2VyXSA9IHt9O1xuICAgIGNvbnN0IG5hdHVyYWxJZCA9IGV4Y2hhbmdlc1N0b3JlLmdldE5hdHVyYWxJZEZyb21Db2RlKHRpY2tlcik7XG4gICAgY29uc3Qgd2FyZWhvdXNlID0gd2FyZWhvdXNlc1N0b3JlLmdldEJ5RW50aXR5TmF0dXJhbElkKG5hdHVyYWxJZCk7XG4gICAgY29uc3QgaW52ID0gc3RvcmFnZXNTdG9yZS5nZXRCeUlkKHdhcmVob3VzZT8uc3RvcmVJZCk7XG5cbiAgICBpZiAoaW52KSB7XG4gICAgICBmb3IgKGNvbnN0IG1hdCBvZiBpbnYuaXRlbXMpIHtcbiAgICAgICAgY29uc3QgcXVhbnRpdHkgPSBtYXQucXVhbnRpdHk7XG4gICAgICAgIGlmIChxdWFudGl0eSkge1xuICAgICAgICAgIHdhclt0aWNrZXJdW3F1YW50aXR5Lm1hdGVyaWFsLnRpY2tlcl0gPSBxdWFudGl0eS5hbW91bnQ7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gIH1cbiAgcmV0dXJuIHtcbiAgICBXQVI6IHdhcixcbiAgfTtcbn1cbiJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBYUEsTUFBQSxpQkFBQSxJQUFBLE1BQUEsa0JBQUE7QUFFTyxNQUFBLGNBQUE7QUFBQSxFQUFvQixZQUFBLFNBQUE7QUFDTCxTQUFBLFVBQUE7QUFBQSxFQUFBO0FBQUEsRUFBZ0MsSUFBQSxNQUFBO0FBR2xELFdBQUEsS0FBQSxRQUFBO0FBQUEsRUFBb0I7QUFBQSxFQUN0QixNQUFBLGNBQUEsS0FBQSxRQUFBO0FBR0UsVUFBQSxRQUFBLGNBQUE7QUFDQSxVQUFBLFFBQUEsQ0FBQTtBQUNBLFFBQUEsT0FBQTtBQUNBLGVBQUEsVUFBQSxJQUFBLFNBQUE7QUFDRSxZQUFBLE9BQUEsSUFBQSxjQUFBLE9BQUEsSUFBQTtBQUNBLFVBQUEsQ0FBQSxNQUFBO0FBQ0U7QUFBQSxNQUFBO0FBRUYsWUFBQSxlQUFBLE9BQUEsUUFBQSxPQUFBLElBQUEsS0FBQSxDQUFBO0FBQ0EsWUFBQSxNQUFBLElBQUE7QUFBQSxRQUFnQixDQUFBLEtBQUEsWUFBQSxLQUFBLElBQUEsV0FBQSxLQUFBLElBQUEsT0FBQSxJQUFBLEtBQUEsT0FBQSxFQUFBO0FBQUEsTUFDd0M7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
