import { userData } from './user-data.js';
import { deepFreeze } from './deep-freeze.js';
import { tilesStore } from './tiles2.js';
import { isEmpty } from './is-empty.js';
import { computed, watch, inject } from './runtime-core.esm-bundler.js';
import { reactive } from './reactivity.esm-bundler.js';
function initializeTileListener() {
  pruneTileStates();
  tilesStore.listener = {
    tilesInitialized() {
      pruneTileStates();
    },
    tileMoved(fromId, toId) {
      moveTileState(fromId, toId);
    },
    tileRemoved(id) {
      removeTileState(id);
    },
  };
}
function pruneTileStates() {
  const tiles = tilesStore.entities.value;
  if (!tiles) {
    return;
  }
  for (const key of Object.keys(userData.tileState)) {
    if (!(key in tiles)) {
      removeTileState(key);
    }
  }
}
function removeTileState(id) {
  delete userData.tileState[id];
}
function moveTileState(fromId, toId) {
  if (userData.tileState[fromId]) {
    userData.tileState[toId] = userData.tileState[fromId];
    removeTileState(fromId);
  }
}
function getTileState(tileOrId) {
  const id = typeof tileOrId === 'string' ? tileOrId : tileOrId.id;
  let state = userData.tileState[id];
  let isAdded = state !== void 0;
  if (!state) {
    state = reactive({});
  }
  const isPersistent = isNaN(Number(id));
  if (isPersistent) {
    watch(
      state,
      () => {
        const hasKeys = Object.keys(state).length > 0;
        if (hasKeys && !isAdded) {
          userData.tileState[id] = state;
          isAdded = true;
        }
        if (!hasKeys && isAdded) {
          delete userData.tileState[id];
          isAdded = false;
        }
      },
      { deep: true },
    );
  }
  return state;
}
const baseTileStateKey = Symbol();
function tileStateKey() {
  return baseTileStateKey;
}
const tileStatePlugin = {
  install: (app, options) => {
    app.provide(
      tileStateKey(),
      computed(() => getTileState(options.tile)),
    );
  },
};
function createTileStateHook(defaultState) {
  deepFreeze(defaultState);
  return function useTileState2(key) {
    const state = inject(tileStateKey());
    return computedTileState(state, key, defaultState[key]);
  };
}
function useTileState(key, defaultValue) {
  const state = inject(tileStateKey());
  return computedTileState(state, key, defaultValue);
}
function computedTileState(state, key, defaultValue) {
  return computed({
    get: () => {
      const value = state.value[key];
      return Object.hasOwn(state.value, key) ? value : defaultValue;
    },
    set: value => {
      if (Array.isArray(value) && isEmpty(value)) {
        delete state.value[key];
        return;
      } else if (typeof value === 'object' && Object.keys(value).length === 0) {
        delete state.value[key];
        return;
      }
      if (value === defaultValue) {
        delete state.value[key];
        return;
      }
      state.value[key] = value;
    },
  });
}
export {
  computedTileState,
  createTileStateHook,
  getTileState,
  initializeTileListener,
  tileStateKey,
  tileStatePlugin,
  useTileState,
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXNlci1kYXRhLXRpbGVzLmpzIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvc3RvcmUvdXNlci1kYXRhLXRpbGVzLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IHVzZXJEYXRhIH0gZnJvbSAnQHNyYy9zdG9yZS91c2VyLWRhdGEnO1xuaW1wb3J0IHsgQXBwLCBQbHVnaW4gfSBmcm9tICd2dWUnO1xuaW1wb3J0IHsgZGVlcEZyZWV6ZSB9IGZyb20gJ0BzcmMvdXRpbHMvZGVlcC1mcmVlemUnO1xuaW1wb3J0IHsgdGlsZXNTdG9yZSB9IGZyb20gJ0BzcmMvaW5mcmFzdHJ1Y3R1cmUvcHJ1bi1hcGkvZGF0YS90aWxlcyc7XG5pbXBvcnQgeyBpc0VtcHR5IH0gZnJvbSAndHMtZXh0cmFzJztcblxudHlwZSBUaWxlU3RhdGUgPSBVc2VyRGF0YS5UaWxlU3RhdGU7XG5cbmV4cG9ydCBmdW5jdGlvbiBpbml0aWFsaXplVGlsZUxpc3RlbmVyKCkge1xuICBwcnVuZVRpbGVTdGF0ZXMoKTtcbiAgdGlsZXNTdG9yZS5saXN0ZW5lciA9IHtcbiAgICB0aWxlc0luaXRpYWxpemVkKCkge1xuICAgICAgcHJ1bmVUaWxlU3RhdGVzKCk7XG4gICAgfSxcbiAgICB0aWxlTW92ZWQoZnJvbUlkOiBzdHJpbmcsIHRvSWQ6IHN0cmluZykge1xuICAgICAgbW92ZVRpbGVTdGF0ZShmcm9tSWQsIHRvSWQpO1xuICAgIH0sXG4gICAgdGlsZVJlbW92ZWQoaWQ6IHN0cmluZykge1xuICAgICAgcmVtb3ZlVGlsZVN0YXRlKGlkKTtcbiAgICB9LFxuICB9O1xufVxuXG5mdW5jdGlvbiBwcnVuZVRpbGVTdGF0ZXMoKSB7XG4gIGNvbnN0IHRpbGVzID0gdGlsZXNTdG9yZS5lbnRpdGllcy52YWx1ZTtcbiAgaWYgKCF0aWxlcykge1xuICAgIHJldHVybjtcbiAgfVxuICBmb3IgKGNvbnN0IGtleSBvZiBPYmplY3Qua2V5cyh1c2VyRGF0YS50aWxlU3RhdGUpKSB7XG4gICAgaWYgKCEoa2V5IGluIHRpbGVzKSkge1xuICAgICAgcmVtb3ZlVGlsZVN0YXRlKGtleSk7XG4gICAgfVxuICB9XG59XG5cbmZ1bmN0aW9uIHJlbW92ZVRpbGVTdGF0ZShpZDogc3RyaW5nKSB7XG4gIGRlbGV0ZSB1c2VyRGF0YS50aWxlU3RhdGVbaWRdO1xufVxuXG5mdW5jdGlvbiBtb3ZlVGlsZVN0YXRlKGZyb21JZDogc3RyaW5nLCB0b0lkOiBzdHJpbmcpIHtcbiAgaWYgKHVzZXJEYXRhLnRpbGVTdGF0ZVtmcm9tSWRdKSB7XG4gICAgdXNlckRhdGEudGlsZVN0YXRlW3RvSWRdID0gdXNlckRhdGEudGlsZVN0YXRlW2Zyb21JZF07XG4gICAgcmVtb3ZlVGlsZVN0YXRlKGZyb21JZCk7XG4gIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldFRpbGVTdGF0ZTxUIGV4dGVuZHMgVGlsZVN0YXRlPih0aWxlT3JJZDogUHJ1blRpbGUgfCBzdHJpbmcpIHtcbiAgY29uc3QgaWQgPSB0eXBlb2YgdGlsZU9ySWQgPT09ICdzdHJpbmcnID8gdGlsZU9ySWQgOiB0aWxlT3JJZC5pZDtcbiAgbGV0IHN0YXRlID0gdXNlckRhdGEudGlsZVN0YXRlW2lkXTtcbiAgbGV0IGlzQWRkZWQgPSBzdGF0ZSAhPT0gdW5kZWZpbmVkO1xuICBpZiAoIXN0YXRlKSB7XG4gICAgc3RhdGUgPSByZWFjdGl2ZSh7fSk7XG4gIH1cbiAgY29uc3QgaXNQZXJzaXN0ZW50ID0gaXNOYU4oTnVtYmVyKGlkKSk7XG4gIGlmIChpc1BlcnNpc3RlbnQpIHtcbiAgICB3YXRjaChcbiAgICAgIHN0YXRlLFxuICAgICAgKCkgPT4ge1xuICAgICAgICBjb25zdCBoYXNLZXlzID0gT2JqZWN0LmtleXMoc3RhdGUpLmxlbmd0aCA+IDA7XG4gICAgICAgIGlmIChoYXNLZXlzICYmICFpc0FkZGVkKSB7XG4gICAgICAgICAgdXNlckRhdGEudGlsZVN0YXRlW2lkXSA9IHN0YXRlO1xuICAgICAgICAgIGlzQWRkZWQgPSB0cnVlO1xuICAgICAgICB9XG4gICAgICAgIGlmICghaGFzS2V5cyAmJiBpc0FkZGVkKSB7XG4gICAgICAgICAgZGVsZXRlIHVzZXJEYXRhLnRpbGVTdGF0ZVtpZF07XG4gICAgICAgICAgaXNBZGRlZCA9IGZhbHNlO1xuICAgICAgICB9XG4gICAgICB9LFxuICAgICAgeyBkZWVwOiB0cnVlIH0sXG4gICAgKTtcbiAgfVxuICByZXR1cm4gc3RhdGUgYXMgVDtcbn1cblxuY29uc3QgYmFzZVRpbGVTdGF0ZUtleSA9IFN5bWJvbCgpIGFzIEluamVjdGlvbktleTxSZWY8VGlsZVN0YXRlPj47XG5cbmV4cG9ydCBmdW5jdGlvbiB0aWxlU3RhdGVLZXk8VCBleHRlbmRzIFRpbGVTdGF0ZT4oKSB7XG4gIHJldHVybiBiYXNlVGlsZVN0YXRlS2V5IGFzIEluamVjdGlvbktleTxSZWY8VD4+O1xufVxuXG5leHBvcnQgY29uc3QgdGlsZVN0YXRlUGx1Z2luOiBQbHVnaW4gPSB7XG4gIGluc3RhbGw6IChhcHA6IEFwcCwgb3B0aW9uczogeyB0aWxlOiBQcnVuVGlsZSB8IHN0cmluZyB9KSA9PiB7XG4gICAgYXBwLnByb3ZpZGUoXG4gICAgICB0aWxlU3RhdGVLZXkoKSxcbiAgICAgIGNvbXB1dGVkKCgpID0+IGdldFRpbGVTdGF0ZShvcHRpb25zLnRpbGUpKSxcbiAgICApO1xuICB9LFxufTtcblxuZXhwb3J0IGZ1bmN0aW9uIGNyZWF0ZVRpbGVTdGF0ZUhvb2s8VCBleHRlbmRzIFRpbGVTdGF0ZT4oZGVmYXVsdFN0YXRlOiBUKSB7XG4gIGRlZXBGcmVlemUoZGVmYXVsdFN0YXRlKTtcbiAgcmV0dXJuIGZ1bmN0aW9uIHVzZVRpbGVTdGF0ZTxLIGV4dGVuZHMga2V5b2YgVD4oa2V5OiBLKSB7XG4gICAgY29uc3Qgc3RhdGUgPSBpbmplY3QodGlsZVN0YXRlS2V5PFQ+KCkpITtcbiAgICByZXR1cm4gY29tcHV0ZWRUaWxlU3RhdGUoc3RhdGUsIGtleSwgZGVmYXVsdFN0YXRlW2tleV0pO1xuICB9O1xufVxuXG5leHBvcnQgZnVuY3Rpb24gdXNlVGlsZVN0YXRlPFQ+KGtleTogc3RyaW5nLCBkZWZhdWx0VmFsdWU6IFQpOiBXcml0YWJsZUNvbXB1dGVkUmVmPFQ+IHtcbiAgY29uc3Qgc3RhdGUgPSBpbmplY3QodGlsZVN0YXRlS2V5KCkpITtcbiAgcmV0dXJuIGNvbXB1dGVkVGlsZVN0YXRlKHN0YXRlLCBrZXksIGRlZmF1bHRWYWx1ZSkgYXMgV3JpdGFibGVDb21wdXRlZFJlZjxUPjtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGNvbXB1dGVkVGlsZVN0YXRlPFQgZXh0ZW5kcyBUaWxlU3RhdGUsIEsgZXh0ZW5kcyBrZXlvZiBUPihcbiAgc3RhdGU6IFJlZjxUPixcbiAga2V5OiBLLFxuICBkZWZhdWx0VmFsdWU6IFRbS10sXG4pIHtcbiAgcmV0dXJuIGNvbXB1dGVkKHtcbiAgICBnZXQ6ICgpID0+IHtcbiAgICAgIC8vIFRvdWNoIHByb3BlcnR5IHRvIHRyaWdnZXIgcmVhY3Rpdml0eVxuICAgICAgY29uc3QgdmFsdWUgPSBzdGF0ZS52YWx1ZVtrZXldO1xuICAgICAgcmV0dXJuIE9iamVjdC5oYXNPd24oc3RhdGUudmFsdWUsIGtleSkgPyB2YWx1ZSA6IGRlZmF1bHRWYWx1ZTtcbiAgICB9LFxuICAgIHNldDogdmFsdWUgPT4ge1xuICAgICAgaWYgKEFycmF5LmlzQXJyYXkodmFsdWUpICYmIGlzRW1wdHkodmFsdWUpKSB7XG4gICAgICAgIGRlbGV0ZSBzdGF0ZS52YWx1ZVtrZXldO1xuICAgICAgICByZXR1cm47XG4gICAgICB9IGVsc2UgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ29iamVjdCcgJiYgT2JqZWN0LmtleXModmFsdWUgYXMgb2JqZWN0KS5sZW5ndGggPT09IDApIHtcbiAgICAgICAgZGVsZXRlIHN0YXRlLnZhbHVlW2tleV07XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cbiAgICAgIGlmICh2YWx1ZSA9PT0gZGVmYXVsdFZhbHVlKSB7XG4gICAgICAgIGRlbGV0ZSBzdGF0ZS52YWx1ZVtrZXldO1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgICBzdGF0ZS52YWx1ZVtrZXldID0gdmFsdWUhO1xuICAgIH0sXG4gIH0pO1xufVxuIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7OztBQVFPLFNBQUEseUJBQUE7QUFDTCxrQkFBQTtBQUNBLGFBQUEsV0FBQTtBQUFBLElBQXNCLG1CQUFBO0FBRWxCLHNCQUFBO0FBQUEsSUFBZ0I7QUFBQSxJQUNsQixVQUFBLFFBQUEsTUFBQTtBQUVFLG9CQUFBLFFBQUEsSUFBQTtBQUFBLElBQTBCO0FBQUEsSUFDNUIsWUFBQSxJQUFBO0FBRUUsc0JBQUEsRUFBQTtBQUFBLElBQWtCO0FBQUEsRUFDcEI7QUFFSjtBQUVBLFNBQUEsa0JBQUE7QUFDRSxRQUFBLFFBQUEsV0FBQSxTQUFBO0FBQ0EsTUFBQSxDQUFBLE9BQUE7QUFDRTtBQUFBLEVBQUE7QUFFRixhQUFBLE9BQUEsT0FBQSxLQUFBLFNBQUEsU0FBQSxHQUFBO0FBQ0UsUUFBQSxFQUFBLE9BQUEsUUFBQTtBQUNFLHNCQUFBLEdBQUE7QUFBQSxJQUFtQjtBQUFBLEVBQ3JCO0FBRUo7QUFFQSxTQUFBLGdCQUFBLElBQUE7QUFDRSxTQUFBLFNBQUEsVUFBQSxFQUFBO0FBQ0Y7QUFFQSxTQUFBLGNBQUEsUUFBQSxNQUFBO0FBQ0UsTUFBQSxTQUFBLFVBQUEsTUFBQSxHQUFBO0FBQ0UsYUFBQSxVQUFBLElBQUEsSUFBQSxTQUFBLFVBQUEsTUFBQTtBQUNBLG9CQUFBLE1BQUE7QUFBQSxFQUFzQjtBQUUxQjtBQUVPLFNBQUEsYUFBQSxVQUFBO0FBQ0wsUUFBQSxLQUFBLE9BQUEsYUFBQSxXQUFBLFdBQUEsU0FBQTtBQUNBLE1BQUEsUUFBQSxTQUFBLFVBQUEsRUFBQTtBQUNBLE1BQUEsVUFBQSxVQUFBO0FBQ0EsTUFBQSxDQUFBLE9BQUE7QUFDRSxZQUFBLFNBQUEsRUFBQTtBQUFBLEVBQW1CO0FBRXJCLFFBQUEsZUFBQSxNQUFBLE9BQUEsRUFBQSxDQUFBO0FBQ0EsTUFBQSxjQUFBO0FBQ0U7QUFBQSxNQUFBO0FBQUEsTUFDRSxNQUFBO0FBRUUsY0FBQSxVQUFBLE9BQUEsS0FBQSxLQUFBLEVBQUEsU0FBQTtBQUNBLFlBQUEsV0FBQSxDQUFBLFNBQUE7QUFDRSxtQkFBQSxVQUFBLEVBQUEsSUFBQTtBQUNBLG9CQUFBO0FBQUEsUUFBVTtBQUVaLFlBQUEsQ0FBQSxXQUFBLFNBQUE7QUFDRSxpQkFBQSxTQUFBLFVBQUEsRUFBQTtBQUNBLG9CQUFBO0FBQUEsUUFBVTtBQUFBLE1BQ1o7QUFBQSxNQUNGLEVBQUEsTUFBQSxLQUFBO0FBQUEsSUFDYTtBQUFBLEVBQ2Y7QUFFRixTQUFBO0FBQ0Y7QUFFQSxNQUFBLG1CQUFBLE9BQUE7QUFFTyxTQUFBLGVBQUE7QUFDTCxTQUFBO0FBQ0Y7QUFFTyxNQUFBLGtCQUFBO0FBQUEsRUFBZ0MsU0FBQSxDQUFBLEtBQUEsWUFBQTtBQUVuQyxRQUFBO0FBQUEsTUFBSSxhQUFBO0FBQUEsTUFDVyxTQUFBLE1BQUEsYUFBQSxRQUFBLElBQUEsQ0FBQTtBQUFBLElBQzRCO0FBQUEsRUFDM0M7QUFFSjtBQUVPLFNBQUEsb0JBQUEsY0FBQTtBQUNMLGFBQUEsWUFBQTtBQUNBLFNBQUEsU0FBQSxjQUFBLEtBQUE7QUFDRSxVQUFBLFFBQUEsT0FBQSxjQUFBO0FBQ0EsV0FBQSxrQkFBQSxPQUFBLEtBQUEsYUFBQSxHQUFBLENBQUE7QUFBQSxFQUFzRDtBQUUxRDtBQUVPLFNBQUEsYUFBQSxLQUFBLGNBQUE7QUFDTCxRQUFBLFFBQUEsT0FBQSxjQUFBO0FBQ0EsU0FBQSxrQkFBQSxPQUFBLEtBQUEsWUFBQTtBQUNGO0FBRU8sU0FBQSxrQkFBQSxPQUFBLEtBQUEsY0FBQTtBQUtMLFNBQUEsU0FBQTtBQUFBLElBQWdCLEtBQUEsTUFBQTtBQUdaLFlBQUEsUUFBQSxNQUFBLE1BQUEsR0FBQTtBQUNBLGFBQUEsT0FBQSxPQUFBLE1BQUEsT0FBQSxHQUFBLElBQUEsUUFBQTtBQUFBLElBQWlEO0FBQUEsSUFDbkQsS0FBQSxDQUFBLFVBQUE7QUFFRSxVQUFBLE1BQUEsUUFBQSxLQUFBLEtBQUEsUUFBQSxLQUFBLEdBQUE7QUFDRSxlQUFBLE1BQUEsTUFBQSxHQUFBO0FBQ0E7QUFBQSxNQUFBLFdBQUEsT0FBQSxVQUFBLFlBQUEsT0FBQSxLQUFBLEtBQUEsRUFBQSxXQUFBLEdBQUE7QUFFQSxlQUFBLE1BQUEsTUFBQSxHQUFBO0FBQ0E7QUFBQSxNQUFBO0FBRUYsVUFBQSxVQUFBLGNBQUE7QUFDRSxlQUFBLE1BQUEsTUFBQSxHQUFBO0FBQ0E7QUFBQSxNQUFBO0FBRUYsWUFBQSxNQUFBLEdBQUEsSUFBQTtBQUFBLElBQW1CO0FBQUEsRUFDckIsQ0FBQTtBQUVKOyJ9
