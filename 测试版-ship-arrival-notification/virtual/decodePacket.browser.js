import { PACKET_TYPES_REVERSE, ERROR_PACKET } from './commons.js';
import { decode } from './base64-arraybuffer.js';
const withNativeArrayBuffer = typeof ArrayBuffer === 'function';
const decodePacket = (encodedPacket, binaryType) => {
  if (typeof encodedPacket !== 'string') {
    return {
      type: 'message',
      data: mapBinary(encodedPacket, binaryType),
    };
  }
  const type = encodedPacket.charAt(0);
  if (type === 'b') {
    return {
      type: 'message',
      data: decodeBase64Packet(encodedPacket.substring(1), binaryType),
    };
  }
  const packetType = PACKET_TYPES_REVERSE[type];
  if (!packetType) {
    return ERROR_PACKET;
  }
  return encodedPacket.length > 1
    ? {
        type: PACKET_TYPES_REVERSE[type],
        data: encodedPacket.substring(1),
      }
    : {
        type: PACKET_TYPES_REVERSE[type],
      };
};
const decodeBase64Packet = (data, binaryType) => {
  if (withNativeArrayBuffer) {
    const decoded = decode(data);
    return mapBinary(decoded, binaryType);
  } else {
    return { base64: true, data };
  }
};
const mapBinary = (data, binaryType) => {
  switch (binaryType) {
    case 'blob':
      if (data instanceof Blob) {
        return data;
      } else {
        return new Blob([data]);
      }
    case 'arraybuffer':
    default:
      if (data instanceof ArrayBuffer) {
        return data;
      } else {
        return data.buffer;
      }
  }
};
export { decodePacket };
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGVjb2RlUGFja2V0LmJyb3dzZXIuanMiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL25vZGVfbW9kdWxlcy8ucG5wbS9lbmdpbmUuaW8tcGFyc2VyQDUuMi4zL25vZGVfbW9kdWxlcy9lbmdpbmUuaW8tcGFyc2VyL2J1aWxkL2VzbS9kZWNvZGVQYWNrZXQuYnJvd3Nlci5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBFUlJPUl9QQUNLRVQsIFBBQ0tFVF9UWVBFU19SRVZFUlNFLCB9IGZyb20gXCIuL2NvbW1vbnMuanNcIjtcbmltcG9ydCB7IGRlY29kZSB9IGZyb20gXCIuL2NvbnRyaWIvYmFzZTY0LWFycmF5YnVmZmVyLmpzXCI7XG5jb25zdCB3aXRoTmF0aXZlQXJyYXlCdWZmZXIgPSB0eXBlb2YgQXJyYXlCdWZmZXIgPT09IFwiZnVuY3Rpb25cIjtcbmV4cG9ydCBjb25zdCBkZWNvZGVQYWNrZXQgPSAoZW5jb2RlZFBhY2tldCwgYmluYXJ5VHlwZSkgPT4ge1xuICAgIGlmICh0eXBlb2YgZW5jb2RlZFBhY2tldCAhPT0gXCJzdHJpbmdcIikge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgdHlwZTogXCJtZXNzYWdlXCIsXG4gICAgICAgICAgICBkYXRhOiBtYXBCaW5hcnkoZW5jb2RlZFBhY2tldCwgYmluYXJ5VHlwZSksXG4gICAgICAgIH07XG4gICAgfVxuICAgIGNvbnN0IHR5cGUgPSBlbmNvZGVkUGFja2V0LmNoYXJBdCgwKTtcbiAgICBpZiAodHlwZSA9PT0gXCJiXCIpIHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIHR5cGU6IFwibWVzc2FnZVwiLFxuICAgICAgICAgICAgZGF0YTogZGVjb2RlQmFzZTY0UGFja2V0KGVuY29kZWRQYWNrZXQuc3Vic3RyaW5nKDEpLCBiaW5hcnlUeXBlKSxcbiAgICAgICAgfTtcbiAgICB9XG4gICAgY29uc3QgcGFja2V0VHlwZSA9IFBBQ0tFVF9UWVBFU19SRVZFUlNFW3R5cGVdO1xuICAgIGlmICghcGFja2V0VHlwZSkge1xuICAgICAgICByZXR1cm4gRVJST1JfUEFDS0VUO1xuICAgIH1cbiAgICByZXR1cm4gZW5jb2RlZFBhY2tldC5sZW5ndGggPiAxXG4gICAgICAgID8ge1xuICAgICAgICAgICAgdHlwZTogUEFDS0VUX1RZUEVTX1JFVkVSU0VbdHlwZV0sXG4gICAgICAgICAgICBkYXRhOiBlbmNvZGVkUGFja2V0LnN1YnN0cmluZygxKSxcbiAgICAgICAgfVxuICAgICAgICA6IHtcbiAgICAgICAgICAgIHR5cGU6IFBBQ0tFVF9UWVBFU19SRVZFUlNFW3R5cGVdLFxuICAgICAgICB9O1xufTtcbmNvbnN0IGRlY29kZUJhc2U2NFBhY2tldCA9IChkYXRhLCBiaW5hcnlUeXBlKSA9PiB7XG4gICAgaWYgKHdpdGhOYXRpdmVBcnJheUJ1ZmZlcikge1xuICAgICAgICBjb25zdCBkZWNvZGVkID0gZGVjb2RlKGRhdGEpO1xuICAgICAgICByZXR1cm4gbWFwQmluYXJ5KGRlY29kZWQsIGJpbmFyeVR5cGUpO1xuICAgIH1cbiAgICBlbHNlIHtcbiAgICAgICAgcmV0dXJuIHsgYmFzZTY0OiB0cnVlLCBkYXRhIH07IC8vIGZhbGxiYWNrIGZvciBvbGQgYnJvd3NlcnNcbiAgICB9XG59O1xuY29uc3QgbWFwQmluYXJ5ID0gKGRhdGEsIGJpbmFyeVR5cGUpID0+IHtcbiAgICBzd2l0Y2ggKGJpbmFyeVR5cGUpIHtcbiAgICAgICAgY2FzZSBcImJsb2JcIjpcbiAgICAgICAgICAgIGlmIChkYXRhIGluc3RhbmNlb2YgQmxvYikge1xuICAgICAgICAgICAgICAgIC8vIGZyb20gV2ViU29ja2V0ICsgYmluYXJ5VHlwZSBcImJsb2JcIlxuICAgICAgICAgICAgICAgIHJldHVybiBkYXRhO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgLy8gZnJvbSBIVFRQIGxvbmctcG9sbGluZyBvciBXZWJUcmFuc3BvcnRcbiAgICAgICAgICAgICAgICByZXR1cm4gbmV3IEJsb2IoW2RhdGFdKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgY2FzZSBcImFycmF5YnVmZmVyXCI6XG4gICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgICBpZiAoZGF0YSBpbnN0YW5jZW9mIEFycmF5QnVmZmVyKSB7XG4gICAgICAgICAgICAgICAgLy8gZnJvbSBIVFRQIGxvbmctcG9sbGluZyAoYmFzZTY0KSBvciBXZWJTb2NrZXQgKyBiaW5hcnlUeXBlIFwiYXJyYXlidWZmZXJcIlxuICAgICAgICAgICAgICAgIHJldHVybiBkYXRhO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgLy8gZnJvbSBXZWJUcmFuc3BvcnQgKFVpbnQ4QXJyYXkpXG4gICAgICAgICAgICAgICAgcmV0dXJuIGRhdGEuYnVmZmVyO1xuICAgICAgICAgICAgfVxuICAgIH1cbn07XG4iXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFFQSxNQUFNLHdCQUF3QixPQUFPLGdCQUFnQjtBQUN6QyxNQUFDLGVBQWUsQ0FBQyxlQUFlLGVBQWU7QUFDdkQsTUFBSSxPQUFPLGtCQUFrQixVQUFVO0FBQ25DLFdBQU87QUFBQSxNQUNILE1BQU07QUFBQSxNQUNOLE1BQU0sVUFBVSxlQUFlLFVBQVU7QUFBQSxJQUNyRDtBQUFBLEVBQ0k7QUFDQSxRQUFNLE9BQU8sY0FBYyxPQUFPLENBQUM7QUFDbkMsTUFBSSxTQUFTLEtBQUs7QUFDZCxXQUFPO0FBQUEsTUFDSCxNQUFNO0FBQUEsTUFDTixNQUFNLG1CQUFtQixjQUFjLFVBQVUsQ0FBQyxHQUFHLFVBQVU7QUFBQSxJQUMzRTtBQUFBLEVBQ0k7QUFDQSxRQUFNLGFBQWEscUJBQXFCLElBQUk7QUFDNUMsTUFBSSxDQUFDLFlBQVk7QUFDYixXQUFPO0FBQUEsRUFDWDtBQUNBLFNBQU8sY0FBYyxTQUFTLElBQ3hCO0FBQUEsSUFDRSxNQUFNLHFCQUFxQixJQUFJO0FBQUEsSUFDL0IsTUFBTSxjQUFjLFVBQVUsQ0FBQztBQUFBLEVBQzNDLElBQ1U7QUFBQSxJQUNFLE1BQU0scUJBQXFCLElBQUk7QUFBQSxFQUMzQztBQUNBO0FBQ0EsTUFBTSxxQkFBcUIsQ0FBQyxNQUFNLGVBQWU7QUFDN0MsTUFBSSx1QkFBdUI7QUFDdkIsVUFBTSxVQUFVLE9BQU8sSUFBSTtBQUMzQixXQUFPLFVBQVUsU0FBUyxVQUFVO0FBQUEsRUFDeEMsT0FDSztBQUNELFdBQU8sRUFBRSxRQUFRLE1BQU07RUFDM0I7QUFDSjtBQUNBLE1BQU0sWUFBWSxDQUFDLE1BQU0sZUFBZTtBQUNwQyxVQUFRLFlBQVU7QUFBQSxJQUNkLEtBQUs7QUFDRCxVQUFJLGdCQUFnQixNQUFNO0FBRXRCLGVBQU87QUFBQSxNQUNYLE9BQ0s7QUFFRCxlQUFPLElBQUksS0FBSyxDQUFDLElBQUksQ0FBQztBQUFBLE1BQzFCO0FBQUEsSUFDSixLQUFLO0FBQUEsSUFDTDtBQUNJLFVBQUksZ0JBQWdCLGFBQWE7QUFFN0IsZUFBTztBQUFBLE1BQ1gsT0FDSztBQUVELGVBQU8sS0FBSztBQUFBLE1BQ2hCO0FBQUEsRUFDWjtBQUNBOyIsInhfZ29vZ2xlX2lnbm9yZUxpc3QiOlswXX0=
